@echo off
SETLOCAL
SET PATH=%PATH%;@OPENCV_PATH_STR@;@NVAR_DYNAMIC_LIBRARY_DIRS@;

REM SpeechLivePortrait offline demo
REM Usage: run_speechliveportrait_offline.bat [options]

REM Set the parameter that will be used to generate the output
SET INPUT_IMAGE=speech_live_portrait_sample_portrait.png
SET INPUT_AUDIO=speech_live_portrait_sample_audio.wav
SET TEMP_VIDEO=speech_live_portrait_output.mp4
SET OUTPUT_VIDEO=speech_live_portrait_final.mp4

REM Running the speech live portrait feature and generating the speech live portrait output. 
REM Note that the output is video-only, ffmpeg is needed to combine with original audio.  
ECHO Generating the temporary result: "%TEMP_VIDEO%"
SpeechLivePortraitApp.exe --model_path=@NVAR_MODEL_DIR@ --in_src=%INPUT_IMAGE% --in_drv=%INPUT_AUDIO% --out=%TEMP_VIDEO% %* --capture_outputs=true
if exist %TEMP_VIDEO% (
	echo The temporary file: "%TEMP_VIDEO%" is generated.
) else (
    echo The temporary file "%TEMP_VIDEO%" does not exist.
)

REM ffmpeg is used to mux the audio with the output video
ffmpeg -y -i %TEMP_VIDEO% -i %INPUT_AUDIO% -c:v copy -c:a aac %OUTPUT_VIDEO%

if exist %OUTPUT_VIDEO% (
    echo The final output file: "%OUTPUT_VIDEO%" exists.
	echo Delete temporary file: "%TEMP_VIDEO%"
	DEL %TEMP_VIDEO%
) else (
    echo The final output: "%OUTPUT_VIDEO%" does not exist. Keep the temporary file: %TEMP_VIDEO%
    echo Please setup the ffmpeg as instructed in the README file.
)
